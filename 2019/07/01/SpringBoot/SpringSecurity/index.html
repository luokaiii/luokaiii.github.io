<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>罗凯的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="根据踏瑞云的权限架构，所认知的SpringSecurity一、 实体类1.1 CoreUser用于存储用户的基本信息，如用户名、密码、真实姓名、手机号、邮箱、是否是管理员、是否禁用、学号、备注、学校备注、组织、权限集合 1.2 Organization组织，包含编号、管理员备注、产品、是否禁用 1.3 OrganizationMemeber组织成员，包含 用户Id、组织Id、组织权限role 1.">
<meta name="keywords" content="帅">
<meta property="og:type" content="article">
<meta property="og:title" content="罗凯的博客">
<meta property="og:url" content="http://yoursite.com/2019/07/01/SpringBoot/SpringSecurity/index.html">
<meta property="og:site_name" content="罗凯的博客">
<meta property="og:description" content="根据踏瑞云的权限架构，所认知的SpringSecurity一、 实体类1.1 CoreUser用于存储用户的基本信息，如用户名、密码、真实姓名、手机号、邮箱、是否是管理员、是否禁用、学号、备注、学校备注、组织、权限集合 1.2 Organization组织，包含编号、管理员备注、产品、是否禁用 1.3 OrganizationMemeber组织成员，包含 用户Id、组织Id、组织权限role 1.">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-07-01T02:49:01.373Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="罗凯的博客">
<meta name="twitter:description" content="根据踏瑞云的权限架构，所认知的SpringSecurity一、 实体类1.1 CoreUser用于存储用户的基本信息，如用户名、密码、真实姓名、手机号、邮箱、是否是管理员、是否禁用、学号、备注、学校备注、组织、权限集合 1.2 Organization组织，包含编号、管理员备注、产品、是否禁用 1.3 OrganizationMemeber组织成员，包含 用户Id、组织Id、组织权限role 1.">
  
    <link rel="alternate" href="/atom.xml" title="罗凯的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="https://i.loli.net/2019/07/04/5d1db2fb9593c58427.gif">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">罗凯的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">一个大帅哥</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-SpringBoot/SpringSecurity" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/01/SpringBoot/SpringSecurity/" class="article-date">
  <time datetime="2019-07-01T02:49:01.373Z" itemprop="datePublished">2019-07-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="根据踏瑞云的权限架构，所认知的SpringSecurity"><a href="#根据踏瑞云的权限架构，所认知的SpringSecurity" class="headerlink" title="根据踏瑞云的权限架构，所认知的SpringSecurity"></a>根据踏瑞云的权限架构，所认知的SpringSecurity</h1><h2 id="一、-实体类"><a href="#一、-实体类" class="headerlink" title="一、 实体类"></a>一、 实体类</h2><h2 id="1-1-CoreUser"><a href="#1-1-CoreUser" class="headerlink" title="1.1 CoreUser"></a>1.1 CoreUser</h2><pre><code>用于存储用户的基本信息，如用户名、密码、真实姓名、手机号、邮箱、是否是管理员、是否禁用、学号、备注、学校备注、组织、权限集合
</code></pre><h2 id="1-2-Organization"><a href="#1-2-Organization" class="headerlink" title="1.2 Organization"></a>1.2 Organization</h2><pre><code>组织，包含编号、管理员备注、产品、是否禁用
</code></pre><h2 id="1-3-OrganizationMemeber"><a href="#1-3-OrganizationMemeber" class="headerlink" title="1.3 OrganizationMemeber"></a>1.3 OrganizationMemeber</h2><pre><code>组织成员，包含 用户Id、组织Id、组织权限role
</code></pre><h2 id="1-4-OrganizationMemeberRole"><a href="#1-4-OrganizationMemeberRole" class="headerlink" title="1.4 OrganizationMemeberRole"></a>1.4 OrganizationMemeberRole</h2><pre><code>组织权限：Administrator 管理员、Teacher 教师、Student 学生
</code></pre><h2 id="1-5-OrganizationAuthorization"><a href="#1-5-OrganizationAuthorization" class="headerlink" title="1.5 OrganizationAuthorization"></a>1.5 OrganizationAuthorization</h2><pre><code>组织授权： 授权Id、过期时间、授权的课程集合
</code></pre><h2 id="二、权限类"><a href="#二、权限类" class="headerlink" title="二、权限类"></a>二、权限类</h2><h2 id="2-1-CoreUserDetails"><a href="#2-1-CoreUserDetails" class="headerlink" title="2.1 CoreUserDetails"></a>2.1 CoreUserDetails</h2><pre><code>该类包含了 CoreUser 的信息，和权限的方法，因此需要继承 CoreUser 类和实现 CoreUserDetails 类：UserDetails extends CoreUser implements UserDetails
即：CoreUserDetails = CoreUser用户信息 + UserDetails的方法 + Organization组织 + OrganizationMember组织内的权限 + OrganizationAuthorization组织授权课程
新增参数：
    organizations：List&lt;Organization&gt;  组织集合
    loginName : String  用户名
    organizationMemebers：List&lt;OrganizationMember&gt;    成员与组织对应的权限
    organizationAuthorizations： List&lt;OrganizationAuthorization&gt;    授权内容
三个构造方法：
    1. 无参构造
    2. 含有 登录名 loginName 的构造函数
    3. 含有 组织集合、组织授权集合、登录名 的构造函数
实现了 UserDetails 的 7 个方法
    getAuthorities()        得到权限集合
    getPassword()           密码
    getUsername()           用户名
    isAccountNonExpired()   账户是否未过期
    isAccountNonLocked()    账户是否未被锁
    isCredentialsNonExpired()   证书是否未过期
    isEnabled()             是否可用
</code></pre><h2 id="2-2-LoginUserService"><a href="#2-2-LoginUserService" class="headerlink" title="2.2 LoginUserService"></a>2.2 LoginUserService</h2><pre><code>用户登录的 Service，实现 UserDetailsService 类的 UserDetails loadUserByUsername(String loginName) 方法，该方法返回 UserDetails，因此需要 CoreUserDetails 实现 CoreUserDetails 类，来将 CoreUserDetails 返回。
在实现的方法中：
    1. 通过 loginName (手机号、邮箱、用户名) 查询数据库中是否存在该用户 --&gt; 得到 CoreUser
    2. 构造一个 带 loginName 的 CoreUserDetails，将 CoreUser 注入 CoreUserDetails &lt;&lt;**1**&gt;&gt;
    3. 查询用户对应的 组织权限(memberList)，并添加到 CoreUserDetails，即 coreUserDetails.setOrganizationMembers(memberList) &lt;&lt;**2**&gt;&gt;
    4. 提取 用户组织权限 中的所有组织Id，得到所有的组织信息(organizations)，添加到 CoreUserDetails，即coreUserDetails.setOrganizations(organizations) &lt;&lt;**3**&gt;&gt;
    5. 通过 组织Id ，得到组织下所有的授权信息(authorizations)，添加到 CoreUserDetails，即 coreUserDetails.setOrganizationAuthorizations(authorizations) &lt;&lt;**4**&gt;&gt;
    6. 最后，将注入之后的 coreUserDetails 返回
</code></pre><h2 id="2-3-MethodSecurityConfig"><a href="#2-3-MethodSecurityConfig" class="headerlink" title="2.3 MethodSecurityConfig"></a>2.3 MethodSecurityConfig</h2><blockquote>
<p>开启方法级别的权限验证。<br>    // @EnableGlocalMethodSecurity()在任何 @Configuration 实例上使用，用来开启基于注解的安全验证<br>    //      prePostEnabled = true ； 表示在方法执行之前进行验证<br>    @EnableGlobalMethodSecurity(prePostEnabled = true)<br>    @Configuration<br>    // GlobalMethodSecurityConfiguration 表示基于方法的安全验证<br>    public class MethodSecurityConfig extends GlobalMethodSecurityConfiguration {</p>
</blockquote>
<pre><code>    @Override
    protected MethodSecurityExpressionHandler createExpressionHandler() {
        // 返回一个 表达式验证的方法级控制器
        return new ResourceMethodSecurityExpressionHandler();
    }
}
</code></pre><h2 id="2-4-ResourceMethodSecurityExpressionHandler"><a href="#2-4-ResourceMethodSecurityExpressionHandler" class="headerlink" title="2.4 ResourceMethodSecurityExpressionHandler"></a>2.4 ResourceMethodSecurityExpressionHandler</h2><pre><code>实现 DefaultMethodSecurityExpressionHandler 控制器的 createSecurityExpressionRoot 方法，重写ResourceMethodSecurityExpressionRoot

public class ResourceMethodSecurityExpressionHandler extends DefaultMethodSecurityExpressionHandler {

    private AuthenticationTrustResolver trustResolver =
            new AuthenticationTrustResolverImpl();

    @Override
    protected MethodSecurityExpressionOperations createSecurityExpressionRoot(Authentication authentication, MethodInvocation invocation) {
        ResourceMethodSecurityExpressionRoot root =
                new ResourceMethodSecurityExpressionRoot(authentication);
        root.setPermissionEvaluator(getPermissionEvaluator());
        root.setTrustResolver(this.trustResolver);
        root.setRoleHierarchy(getRoleHierarchy());
        return root;
    }
}
</code></pre><h2 id="2-5-ResourceMethodSecurityExpressionRoot"><a href="#2-5-ResourceMethodSecurityExpressionRoot" class="headerlink" title="2.5 ResourceMethodSecurityExpressionRoot"></a>2.5 ResourceMethodSecurityExpressionRoot</h2><pre><code>自定义 MethodSecurity 的表达式，eg：

public class ResourceMethodSecurityExpressionRoot extends SecurityExpressionRoot implements MethodSecurityExpressionOperations {
    private static final Logger logger = LoggerFactory.getLogger(ResourceMethodSecurityExpressionRoot.class);
    private Object filterObject;
    private Object returnObject;
    private Object target;
    public ResourceMethodSecurityExpressionRoot(Authentication authentication) {
        super(authentication);
    }
    // 用来在 @PreAuthorize 注解中使用的方法
    public boolean canReadCourse(String courseId) {
        logger.debug(&quot;method params courseId : {}&quot;, courseId);
        logger.debug(&quot;current principal {}&quot;, getPrincipal());
        return true;
    }
    /** setter and getter */
}
</code></pre><h1 id="三、大致的流程："><a href="#三、大致的流程：" class="headerlink" title="三、大致的流程："></a>三、大致的流程：</h1><pre><code>1. 用户登录，判定用户名密码是否正确，登录成功此时会将登录名交给 UserSetailsService
2. 在 loadUserByUsername(String loginName) 方法中，填充用户的组织等信息，并返回
    此时的用户已经通过 验证了
2. 在请求资源时，在需要判定的方法上加上注解：@PreAuthorize(&quot;hasRole(&apos;Administrator&apos;)&quot;) 
</code></pre><h1 id="四、常用的注解"><a href="#四、常用的注解" class="headerlink" title="四、常用的注解"></a>四、常用的注解</h1><pre><code>access()                    SpringEL表达式结果为true时可访问
anonymous()                 匿名可访问
denyAll()                   用户不可访问
fullyAuthenticated()        用户完全认证可访问（非Remeber me下自动登录）
hasAnyAuthority(String...)  参数中任意 权限 的用户可访问
hasAnyRole(String...)       参数中任意 角色 的用户可访问
hasAuthority(String)        某一 权限 的用户可访问
hasRole(String)             某一 角色 的用户可访问
permitAll()                 所有用户可访问
rememberMe()                允许通过 remeber me 登录的用户访问
hasIpAddress(String)        用户来自参数中的ip时可访问
</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/01/SpringBoot/SpringSecurity/" data-id="cjxpj02tf002frgtwdwwufkxk" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/07/01/SpringBoot/Sso单点登录/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2019/07/01/SpringBoot/SpringBoot配置文件/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Docker学习/">Docker学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git命令学习/">Git命令学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA-核心知识点整理/">JAVA 核心知识点整理</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java并发编程与高并发解决方案/">Java并发编程与高并发解决方案</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java并发编程的艺术/">Java并发编程的艺术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java成神之路/">Java成神之路</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Java成神之路/SpringBoot/">SpringBoot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java成神之路/Study社区/">Study社区</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux学习之路/">Linux学习之路</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MarkDown语法/">MarkDown语法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/React学习/">React学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringBoot-参考指南/">SpringBoot 参考指南</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具函数/">工具函数</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/高性能MySQL/">高性能MySQL</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git-Bash/">Git Bash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MQ/">MQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/POI/">POI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Cloud/">Spring Cloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Data/">Spring Data</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/">SpringBoot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gradle/">gradle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/poi/">poi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/并发编程/">并发编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/读书笔记/">读书笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高并发/">高并发</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Git/" style="font-size: 13.75px;">Git</a> <a href="/tags/Git-Bash/" style="font-size: 11.25px;">Git Bash</a> <a href="/tags/Linux/" style="font-size: 12.5px;">Linux</a> <a href="/tags/MQ/" style="font-size: 15px;">MQ</a> <a href="/tags/MySQL/" style="font-size: 17.5px;">MySQL</a> <a href="/tags/POI/" style="font-size: 16.25px;">POI</a> <a href="/tags/Spring-Cloud/" style="font-size: 10px;">Spring Cloud</a> <a href="/tags/Spring-Data/" style="font-size: 12.5px;">Spring Data</a> <a href="/tags/SpringBoot/" style="font-size: 15px;">SpringBoot</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/gradle/" style="font-size: 11.25px;">gradle</a> <a href="/tags/java/" style="font-size: 20px;">java</a> <a href="/tags/poi/" style="font-size: 10px;">poi</a> <a href="/tags/并发编程/" style="font-size: 12.5px;">并发编程</a> <a href="/tags/数据库/" style="font-size: 17.5px;">数据库</a> <a href="/tags/读书笔记/" style="font-size: 18.75px;">读书笔记</a> <a href="/tags/高并发/" style="font-size: 12.5px;">高并发</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/12/30/blog/2019/">2019年目标</a>
          </li>
        
          <li>
            <a href="/2019/12/01/读书笔记/《Java并发编程的艺术》/0.0_目录/">《Java并发编程的艺术》读书笔记 - 目录</a>
          </li>
        
          <li>
            <a href="/2019/12/01/读书笔记/《Java核心知识点整理》/0.目录/">《JAVA 核心知识点整理》读书笔记 - 目录</a>
          </li>
        
          <li>
            <a href="/2019/11/30/读书笔记/《高性能MySQL》/0.目录/">《高性能MySQL》读书笔记 - 目录</a>
          </li>
        
          <li>
            <a href="/2019/07/05/读书笔记/《JavaDesignPatterns》/8.建造者模式/">《Java Design Patterns》第六章 建造者模式 - 复杂对象的组装与创建</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 koral<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>