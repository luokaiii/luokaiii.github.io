---
title: Spring Cloud Consul
date: 2020-12-14 09:00:00
categories:
  - SpringCloud
top: true
tags: 
  - SpringCloud
  - SpringCloudConsul
---
# Spring Cloud Consul

Spring Cloud Consul 提供了一个 Consul 用于集成 Spring Boot 应用自动配置。

<!-- More -->

## 一、安装 Consul

### 1.1 安装 Chocolatey

Chocolatey 是一个 Windows 下的软件包管理器，让用户可以像在 Unix 系统中使用 Yum 和 APT 一样使用它。

**安装**，详见 [chocolatey install](https://chocolatey.org/install)。

1. 以管理员身份运行 PowerShell

2. 运行以下命令：

   1. ```sh
      Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
      ```

3. 验证安装：`choco`

### 1.2 安装 Consul

**Consul** 是一个提供服务发现的网络工具。

**安装**，详见 [consul install](https://learn.hashicorp.com/tutorials/consul/get-started-install)。

1. 使用 Chocolatey 安装：`$ choco install consul`
2. 验证安装：`$ consul`

### 1.3 consul agent

在生产环境中，分为 Server 和 Client 两种 agent 代理。每个 Consul 必须有至少一个 Server，负责维护 Consul 的状态（包括其它 Consul 和 Client 的信息）。

为了保证 Server 能稳定运行，推荐部署 3-5个（奇数，且不超过5个）生产的 Server。

**1. 使用开发模式启动 Consul 代理**

```sh
$ consul agent -dev
==> Starting Consul agent...
         Version: '1.8.5'
         Node ID: '17efd084-5257-e554-736f-1ad69a2c0c8d'
         Node name: 'LAPTOP-K78S7NC8'
         ......
```

> 注：不要在生产中使用 `-dev`

**2. 查看 Consul 的成员**

服务端命令：

```sh
$ consul members # -detailed 查看详细信息
Node             Address         Status  Type    Build  Protocol  DC   Segment
LAPTOP-K78S7NC8  127.0.0.1:8301  alive   server  1.8.5  2         dc1  <all> 
```

客户端 HTTP API：

```sh
$ curl http://localhost:8500/v1/catalog/nodes
StatusCode        : 200
StatusDescription : OK
Content           : [
                        {
                            "ID": "17efd084-5257-e554-736f-1ad69a2c0c8d",
                            "Node": "LAPTOP-K78S7NC8",
                            "Address": "127.0.0.1",
                            "Datacenter": "dc1",
                            "TaggedAddresses": {
                                "...
......
```

客户端 DNS 接口：

```sh
$ dig @127.0.0.1 -p 8600 Judiths-MBP.node.consul
```

### 1.4 停止 agent

关闭 Consul agent。

```sh
$ consul leave
```

当发出 leave 命令后，Consul 通知其它成员 datacenter。每当一个 agent 离开，会将它们从 catalog 中删除。

> 其它API，详见 [Consul](https://learn.hashicorp.com/consul)

## 二、注册服务

### 2.1 引入依赖

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-consul-discovery</artifactId>
</dependency>
```

### 2.2 注册

将一个 Spring Boot 服务，注册到 Consul 中。

**application.properties**:

```properties
# 服务名称与端口
spring.application.name=server1
server.port=8081

# Consul Server 的地址
spring.cloud.consul.host=localhost
spring.cloud.consul.port=8500
```

> 另外再注册一个 server2，用于下一步的测试

## 三、DiscoveryClient

Spring Cloud 支持 **Feign**，也支持 **Spring RestTemplate** 使用逻辑服务名，而不是实际的URL。

还可以使用 **DiscoveryClient**，提供简单的 API，如下：

```java
@RestController
@EnableDiscoveryClient
@SpringBootApplication
public class ServerApplication {
    @Autowired
    private DiscoveryClient discoveryClient;
    
    public static void main(String[] args) {
        SpringApplication.run(ServerApplication.class, args);
    }
    
    @GetMapping("/clients")
    public void getAllClients() {
        List<ServiceInstance> list = discoverClient.getInstance("server2");
        if (list != null && list.size() > 0) {
			for (ServiceInstance instance: list) {
                System.out.println(instance.getUri());
            }
        }
    }
}
```

至此，服务发现已完毕。

## 四、异常

### 4.1 注册的服务检测失败

异常：在 Consul Services 中注册的服务显示检测失败：All Service checks failing。

原因：默认情况下，Consul Client 的健康检查地址为 **/actuator/health**。

解决方法一：引入 `spring-boot-starter-actuator` 依赖，则该框架会自动注册 **/actuator** 相关的健康检查路径。

解决方法二：修改 **spring.cloud.consul.discovery.health-check-path** 健康检查路径，将其改为存在的路径即可。

### 4.2 无法使用服务名消费

```java
@GetMapping("/test")
public void test() {
    String result = new RestTemplate().getForObject("http://server1/test", String.class);
    System.out.println(result);
}
```

异常：**java.net.UnknownHostException: server1**。

原因：RestTemplate 需要使用 LoadBalancerClient 的实例。

解决方法：将 RestTemplate 声明为 Bean，并标注为 LoadBalanceClient，如下：

```java
@Bean
@LoadBalanced
public RestTemplate restTemplate() {
    return new RestTemplate();
}
```

