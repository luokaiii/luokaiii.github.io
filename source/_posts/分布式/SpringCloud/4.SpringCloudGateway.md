---
title: Spring Cloud Gateway
date: 2020-12-14 09:00:00
categories:
  - SpringCloud
top: true
tags: 
  - SpringCloud
  - SpringCloudGateway
---
# Spring Cloud Gateway

Spring Cloud Gateway 基于 Spring Framework 5.0、Spring Boot 2.0 和 Project Reactor 所开发的网关，提供一种简单有效的 API 路由管理方式。

集成了 Hystrix 断路器、Spring Cloud DiscoveryClient、具备动态路由、限流、路径重写等高级功能。

通过 Predicates 和 Filters 作用于特定的路由。

<!-- More -->

## 一、引入依赖

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>
```

查看 `spring-cloud-starter-gateway` 的依赖，可以看到其依赖了以下四个框架：

- spring-cloud-starter
  - Spring Boot 式的启动项目，为 Spring Cloud 项目提供依赖管理
- spring-cloud-gateway-server
- spring-boot-starter-webflux
  - 提供响应式API、异步处理
- spring-cloud-starter-loadbalancer
  - 负载均衡

## 二、数据字典与用法

- **Route**：**路由**，由 ID、URI、判断规则组、过滤器组组成，用于匹配路由
- **Predicate**：**断言**，匹配来自 Http 请求的任何内容（如Header、Param等）
- **Filter**：**过滤器**，在请求之前/之后修改 request 与 response

普通的用法：

```yaml
spring:
  cloud:
  	consul:
  	  # 不需要注册到 Consul，因为不对其它服务提供接口
  	  discovery:
  	  	register: false
  	  host: localhost
  	  port: 8500
    gateway:
      routes:
        - id: user-service
          uri: lb://user-server
          predicates:
            - Path=/user
        - id: baidu-service
          uri: https://www.baidu.com
          predicates:
            - Path=/baidu
```



### 微服务网关 Zuul 与 Gateway 的区别

| 区别     | Zuul                                                         | Gateway                                                      |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 内部实现 | Servlet                                                      | Servlet + Spring Webflux                                     |
| 包       | spring-cloud-starter-netflix-zuul                            | spring-cloud-starter-webflux  + spring-cloud-starter-gateway |
| 作用     | Web网关                                                      | Web网关                                                      |
| 扩展性   | 可扩展至其它微服务框架                                       | 仅支持 Spring Cloud 生态组件                                 |
| 异步支持 | 阻塞式 API，不支持长连接（如 WebSocket）                     | Netty 底层环境，提供了异步支持、负载均衡、请求限流等         |
| 限流     | 由 Hystrix 支持                                              | 默认实现了 RedisRateLimiter                                  |
| 性能     | Zuul 1.X，基于阻塞IO的网关；从Zuul 2.x 开始，改为基于Netty，非阻塞，也支持websocket。但是 Spring Cloud 暂未整合 | 基于 Spring Webflux，是一个非阻塞的 Reactive Web 框架，可以用来构建异步的、非阻塞的、事件驱动的服务，伸缩性非常好 |

Spring Webflux 支持两种开发模式：

1. 基于注解(@Controller、@RequestMapping)的开发模式
2. Java8 Lambda 风格的函数式开发模式

## 异常

### 1. 项目启动失败，提示 Spring MVC found on classpath

异常：Spring MVC found on classpath, which is incompatible with Spring Cloud Gateway at this time. Please remove spring-boot-starter-web dependency.

原因：Spring Cloud Gateway 不能依赖 SpringMVC

解决方法：移除 spring-boot-starter-web 依赖

## 参考资料

- https://docs.spring.io/spring-cloud-gateway/docs/2.2.5.RELEASE/reference/html
- 