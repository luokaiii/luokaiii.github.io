---
title: 《Spring Security》第六章 SpringSecurity 身份认证流程
date: 2019-07-18 18:45:00
tags: 
  - 读书笔记
categories:
  - Spring Security
---

# 第六章 SpringSecurity 身份认证流程

## 一、标准的身份认证

一个标准的身份验证流程：

1. 用户提供用户名与密码
2. 系统验证用户名密码是否正确
3. 获取该用户的上下文信息（如角色列表、权限等）
4. 为用户建立安全上下文
5. 访问受保护资源时，通过上下文信息验证权限

以下示例来自于 `Spring Security Reference`，演示了一个简单的迷你认证环境。

### 模拟身份认证

```java
public class AuthenticationExample {
private static AuthenticationManager am = new SampleAuthenticationManager();

public static void main(String[] args) throws Exception {
	BufferedReader in = new BufferedReader(new InputStreamReader(System.in));

	while(true) {
        // 1. 接收用户名与密码
	System.out.println("Please enter your username:");
	String name = in.readLine();
	System.out.println("Please enter your password:");
	String password = in.readLine();
	try {
        // 2. 生成 token
		Authentication request = new UsernamePasswordAuthenticationToken(name, password);
        // 3. 验证 token 是否正确
		Authentication result = am.authenticate(request);
        // 4. 将认证主题注入上下文
        SecurityContextHolder.getContext().setAuthentication(result);
		break;
	} catch(AuthenticationException e) {
		System.out.println("Authentication failed: " + e.getMessage());
	}
	}
	System.out.println("Successfully authenticated. Security context contains: " +
			SecurityContextHolder.getContext().getAuthentication());
}
}

class SampleAuthenticationManager implements AuthenticationManager {
static final List<GrantedAuthority> AUTHORITIES = new ArrayList<GrantedAuthority>();

static {
	AUTHORITIES.add(new SimpleGrantedAuthority("ROLE_USER"));
}

public Authentication authenticate(Authentication auth) throws AuthenticationException {
	if (auth.getName().equals(auth.getCredentials())) {
	return new UsernamePasswordAuthenticationToken(auth.getName(),
		auth.getCredentials(), AUTHORITIES);
	}
	throw new BadCredentialsException("Bad Credentials");
}
}
```

通常情况下，这个流程是由 Spring Security 内部执行的，但是这大致显示了 Spring Security 通过 username、password 构建一个 SecurityContext 的过程。

### 直接设置 SecurityContextHolder

如果你需要在一个已经拥有身份认证的系统（如自定义了过滤器或MVC控制器、拥有自己的认证系统等）中，接入 Spring Security 环境。

只需要在原有系统中读取第三方用户信息，构建一个 Spring Security 特定的 Authentication 对象，并将其放入 SecurityContextHolder 中即可。

## 二、Web应用中的身份验证

在一个Web 应用程序中使用 Spring Security 访问受保护的资源，流程如下：

![访问Web受保护资源的流程](https://i.loli.net/2019/07/18/5d304878a579473801.png)

Spring Security 中提供了不同的类负责上图中的不同流程，主要参与者（按照使用顺序）是 ExceptionTranslationFilter、AuthenticationEntryPoint和 authentication mechanism。负责调用的是 AuthenticationManager。