# @EnableWebSecurity 注解

在 Spring Boot 应用中使用 Spring Security ，用到了 @EnableWebSecurity 注解，该注解和 @Configuration 注解一起使用，注解 WebSecurityConfigurer 类型的类，或者利用 @EnableWebSecurity 注解 + 继承 WebSecurityConfigurerAdapter 的类，构成 Spring Security 的配置。

## WebSecurityConfigurerAdapter

一般情况下，会选择继承 WebSecurityConfigurerAdapter 类，它提供了一种遍历的方式去创建 WebSecurityConfigurer 的实例，只需要重写其中的方法，即可配置拦截URL、设置权限等安全控制。从下图中可以看到能进行重写的方法：

![可重写的方法](https://upload-images.jianshu.io/upload_images/13603359-6a633a7a38615007.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 具体的方法描述

```java
@EnableWebSecurity
@Configuration
public class KoralSecurityConfig extends WebSecurityConfigurerAdapter {

    /**
     * 其父类 WebSecurityConfigurerAdapter 中通过构造默认构造函数
     *  创建启用了默认配置的实例
     */
    protected KoralSecurityConfig() {
        super();
    }

    /**
     * 是否重新设置一个实例
     * @param disableDefaults 是否启用默认的配置，default:true
     */
    protected KoralSecurityConfig(boolean disableDefaults) {
        super(disableDefaults);
    }

    /**
     * 使用 AuthenticationManagerBuilder 来指定重写后的 AuthenticationManager
     * @param auth AuthenticationManager 的 构造器
     * @throws Exception 异常
     */
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        super.configure(auth);
    }

    /**
     * 重写此方法,通过其返回值来暴露 AuthenticationManager
     * @return AuthenticationManager
     * @throws Exception Exception
     */
    @Override
    public AuthenticationManager authenticationManagerBean() throws Exception {
        return super.authenticationManagerBean();
    }

    /**
     * 如果默认的 AuthenticationManagerBuilder 策略被重写的话，则传入重写的
     *  否则，自动装入 AuthenticationManager
     * @return AuthenticationManager
     * @throws Exception Exception
     */
    @Override
    protected AuthenticationManager authenticationManager() throws Exception {
        return super.authenticationManager();
    }


    @Override
    public UserDetailsService userDetailsServiceBean() throws Exception {
        return super.userDetailsServiceBean();
    }

    @Override
    protected UserDetailsService userDetailsService() {
        return super.userDetailsService();
    }

    @Override
    public void init(WebSecurity web) throws Exception {
        super.init(web);
    }

    /**
     * 可以通过该方法来过滤一些web请求
     * @param web WebSecurity
     * @throws Exception ex
     */
    @Override
    public void configure(WebSecurity web) throws Exception {
        super.configure(web);
    }

    /**
     * 通过该方法配置 HttpSecurity
     *  默认配置为：
     *      http.authorizeRequests().anyRequest().authenticated().and().formLogin().and().httpBasic();
     *  注意：
     *      该方法最好不要调用 super() 方法，因为可能会覆盖你的配置
     * @param http HttpSecurity
     * @throws Exception ex
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        super.configure(http);
    }

    /**
     * 重新配置应用上下文
     * @param context ApplicationContext
     */
    @Override
    public void setApplicationContext(ApplicationContext context) {
        super.setApplicationContext(context);
    }

    /**
     * 重新配置 认证评估标记
     * @param trustResolver AuthenticationTrustResolver
     */
    @Override
    public void setTrustResolver(AuthenticationTrustResolver trustResolver) {
        super.setTrustResolver(trustResolver);
    }

    /**
     * 设置 请求的相应策略
     * @param contentNegotiationStrategy 策略
     */
    @Override
    public void setContentNegotationStrategy(ContentNegotiationStrategy contentNegotiationStrategy) {
        super.setContentNegotationStrategy(contentNegotiationStrategy);
    }

    /**
     * 设置 对象请求的生命周期
     * @param objectPostProcessor 对象
     */
    @Override
    public void setObjectPostProcessor(ObjectPostProcessor<Object> objectPostProcessor) {
        super.setObjectPostProcessor(objectPostProcessor);
    }

    /**
     * 身份认证的配置
     * @param authenticationConfiguration configure
     */
    @Override
    public void setAuthenticationConfiguration(AuthenticationConfiguration authenticationConfiguration) {
        super.setAuthenticationConfiguration(authenticationConfiguration);
    }
}

```

## 详解 HttpSecurity

final HttpSecurity 的常用方法如下：

方法 | 说明
---- | ----
openIDLogin() | 用于基于OpenID的验证
headers() | 将安全标头添加到响应
cors() | 配置跨域资源共享（CORS）
sessionManagement() | 允许配置会话管理
portMapper() | 允许配置一个PortMapper(HttpSecurity#(getSharedObject(class))),其他提供SecurityConfigurer 的对象使用 PortMapper 从 HTTP 重定向到HTTPS或者返回来。默认情况下，SpringSecurity 使用一个 PortMapperImpl 映射 HTTP 端口 8080 到Https 端口 8443，Http端口 80 到 https 端口 8443
jee() | 配置基于容器的预认证。在这种情况下，认证由Servlet容器管理
x509() | 配置基于X509的认证
rememberMe | 允许配置“记住我”的验证
authorizeRequests() | 允许基于使用 HttpServletRequest 限制访问
requestCache() | 允许配置请求缓存
exceptionHandling() | 允许配置错误处理
securityContext() | 在HttpServletRequests之间的SecurityContextHolder上设置SecurityContext的管理。 当使用WebSecurityConfigurerAdapter时，这将自动应用
servletApi() | 将 HttpServletRequests 方法与在其上找到的值集成到 SecurityContext 中。当时用 WebSecurityConfigurerAdapter 时，将自动应用。
csrf() | 添加 CSRF 支持，使用WebSecurityConfigurerAdapter时，默认启用
logout() | 添加退出登录支持。当使用WebSecurityConfigurerAdapter时，这将自动应用。默认情况是，访问URL”/ logout”，使HTTP Session无效来清除用户，清除已配置的任何#rememberMe()身份验证，清除SecurityContextHolder，然后重定向到”/login?success”
anonymous() | 允许配置匿名用户的表示方法。 当与WebSecurityConfigurerAdapter结合使用时，这将自动应用。 默认情况下，匿名用户将使用org.springframework.security.authentication.AnonymousAuthenticationToken表示，并包含角色 “ROLE_ANONYMOUS”
formLogin() | 指定支持基于表单的身份验证。如果未指定FormLoginConfigurer#loginPage(String)，则将生成默认登录页面
oauth2Login() | 根据外部OAuth 2.0或OpenID Connect 1.0提供程序配置身份验证
requiresChannel() | 配置通道安全。为了使该配置有用，必须提供至少一个到所需信道的映射
httpBasic() | 配置 Http Basic 验证
addFilterAt() | 在指定的Filter类的位置添加过滤器

## 示例

```java
// 使用以下配置在内存中进行注册公开内存的身份验证{@link UserDetailsService}
@Override
protected void configure(AuthenticationManagerBuilder auth){
    auth
        .inMemoryAuthentication()
        .withUser("user").password("password").roles("USER")
        .and()
        .withUser("admin").password("password").roles("USER","ADMIN");
}

// 将 UserDetailsService 注册为 Bean
@Bean
@Override
public UserDetailsService userDeatilsServiceBean() throws Exception{
    return super.userDetailsServiceBean();
}
```

```java
/**
 * 覆盖 HTTPSecurity 的配置
 * 默认配置为：http.authorizeRequests().anyRequest().authenticated().formLogin().and().httpBasic();
 */
@Override
protected void configure(HttpSecurity http) throws Exception{
    http
        .authorizeRequests()    // 允许基于使用HttpServletRequest限制访问
            .anyRequest().autheticated()
        .and()
            .formLogin()    // 指定支持基于表单的身份验证。如果未指定，则将默认生成登录页面
        .and()
            .httpBasic();   // 配置HttpBasic 验证
}
```

[文章来源:Spring4all]('http://www.spring4all.com/article/419')